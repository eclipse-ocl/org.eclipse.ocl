<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Validators</title>
<link href="book.css" rel="stylesheet" type="text/css">
<meta content="DocBook XSL Stylesheets V1.75.1" name="generator">
<link rel="home" href="index.html" title="OCL Documentation">
<link rel="up" href="PivotProgrammersGuide.html" title="Unified or Pivot Programmers Guide">
<link rel="prev" href="PivotProgrammersGuide.html" title="Unified or Pivot Programmers Guide">
<link rel="next" href="PivotEvaluator.html" title="The Pivot Evaluator">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<h1 xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0">Validators</h1>
<div class="section" title="Validators">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both">
<a name="Validators"></a>Validators</h2>
</div>
</div>
</div>
<p>When using the Pivot metamodel, there are two specialized validators available to support integration of OCL in to a larger Ecore environment.</p>
<div class="section" title="Validation Code">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="ValidationCode"></a>Validation Code</h3>
</div>
</div>
</div>
<p>Before we describe OCL validation we need to review standard EMF validation.</p>
<div class="section" title="Static / Global Validation">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="GlobalValidation"></a>Static / Global Validation</h4>
</div>
</div>
</div>
<p>EMF validation comprises two phases.</p>
<p>The first initialization phase populates the global validation registry 
						<code class="code">EValidator.Registry.INSTANCE</code> with a mapping from an 
						<code class="code">EPackage</code> whose elements need validation to the derived 
						<code class="code">EValidator</code> that will perform the validation. This initialization is typically performed at the end of the 
						<code class="code">XXXPackageImpl.init()</code> auto-generated by genmodel.
					</p>
<div class="literallayout">
<p>
<code class="code">EValidator.Registry.INSTANCE.put(myEPackage,&nbsp;myEValidator);	<br>

</code>
</p>
</div>
<p></p>
<p>For standalone usage, this is executed as a side effect of referencing the model by e.g. 
						<code class="code">XXXPackage.eINSTANCE</code>. For IDE usage, the 
						<code class="code">org.eclipse.emf.ecore.generated_package</code> extension point ensures timely initialization. Either way, the initialization normally occurs without any special programming effort.
					</p>
<p>The second validation phase offers each model element to an appropriate 
						<code class="code">EValidator</code> and accumulates the results as a list of 
						<code class="code">BasicDiagnostic</code>. The 
						<code class="code">Diagnostician</code> is often used to orchestrate this using code such as:
					</p>
<div class="literallayout">
<p>
<code class="code">Diagnostician&nbsp;diagnostician&nbsp;=&nbsp;Diagnostician.INSTANCE;<br>
Map&lt;Object,&nbsp;Object&gt;&nbsp;context&nbsp;=&nbsp;diagnostician.createDefaultContext();<br>
BasicDiagnostic&nbsp;diagnostics&nbsp;=&nbsp;diagnostician.createDefaultDiagnostic(eObject);<br>
diagnostician.validate(eObject,&nbsp;diagnostics,&nbsp;context);	<br>

</code>
</p>
</div>
<p></p>
</div>
<div class="section" title="Dynamic / Local Validation">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="LocalValidation"></a>Dynamic / Local Validation</h4>
</div>
</div>
</div>
<p>An EMF 
						<code class="code">ResourceSet</code> provides a local 
						<code class="code">EPackage.Registry</code> and 
						<code class="code">Resource.Factory.Registry</code> that delegates to the corresponding global registry. This allows an EMF-based application to register the 
						<code class="code">EPackage</code> and 
						<code class="code">ResourceFactory</code> for an application-specific purpose without leaking them to other applications. This also allows the garbage collector to clean up when an application completes.  
						Unfortunately EMF provides no corresponding support for a local 
						<code class="code">EValidator.Registry</code>. This provides a significant challenge for the OCL tooling where for instance an application may load a Complete OCL document with additional constraints that need validation. These additions should not affect other concurrent or subsequent applications.
					</p>
<div class="section" title="OCL EValidator registration pre 2023-12">
<div class="titlepage">
<div>
<div>
<h5 class="title">
<a name="EValidatorRegistrationPre2023-12"></a>OCL EValidator registration pre 2023-12</h5>
</div>
</div>
</div>
<p>With only a global validation registry available, the old approach was to install the dynamic contributions into the global registry using a 
							<code class="code">ComposedEValidator</code> to ensure that multiple validators are registered with the appropriate one chosen according to the 
							<code class="code">ResourceSet</code> of the validated 
							<code class="code">EObject</code>.
						</p>
<p>This sort of works, but impairs garbage collection and has given trouble to users attempting to run multiple editors.</p>
</div>
<div class="section" title="OCL EValidator registration post 2023-12">
<div class="titlepage">
<div>
<div>
<h5 class="title">
<a name="EValidatorRegistrationPost2023-12"></a>OCL EValidator registration post 2023-12</h5>
</div>
</div>
</div>
<p>The 2023-12 OCL release introduces a local validation registry using 
							<code class="code">ValidationRegistryAdapter</code> to install a 
							<code class="code">ValidationRegistryImpl</code> as a 
							<code class="code">ResourceSet</code> 
							<code class="code">Adapter</code>. It delegates to the global validation registry. A 
							<code class="code">ComposedEValidator</code> may still be used to compose a 
							<code class="code">CompleteOCLEValidator</code> and a regular 
							<code class="code">EObjectValidator</code> but they are 
							<code class="code">ResourceSet</code>-specific and so do not impose a GC-lockin via a global facility.
						</p>
<p>Use of a local validation registry has a significant impact on application code.</p>
<p>It is no longer possible to register OCL validators in some convenient initialization method. Validation Registry initialization, just like Resource Factory initialization cannot occur until the 
							<code class="code">ResourceSet</code> is created.
						</p>
<div class="literallayout">
<p>
<code class="code">ValidationRegistryAdapter.getAdapter(myResourceSet)<br>
	.put(myEPackage,&nbsp;myEValidator);<br>

</code>
</p>
</div>
<p></p>
<p>It is no longer possible to use 
							<code class="code">Diagnostician.INSTANCE</code> to orchestrate validation. The variant constructor with a validation registry argument must be used.
						</p>
<div class="literallayout">
<p>
<code class="code">Diagnostician&nbsp;diagnostician&nbsp;=&nbsp;new&nbsp;Diagnostician(<br>
	ValidationRegistryAdapter.getAdapter(myResourceSet));<br>

</code>
</p>
</div>
<p></p>
<p>Optionally the new 
							<code class="code">ValidationContext</code> may be used in place of the 
							<code class="code">Map&lt;Object,Object&gt;</code> to support the following idiom
						</p>
<div class="literallayout">
<p>
<code class="code">ValidationRegistryAdapter&nbsp;validationRegistry&nbsp;=<br>
	ValidationRegistryAdapter.getAdapter(myEObject);<br>
ValidationContext&nbsp;validationContext&nbsp;=&nbsp;new&nbsp;ValidationContext(validationRegistry);<br>
Diagnostician&nbsp;diagnostician&nbsp;=&nbsp;validationContext.getDiagnostician();<br>
Diagnostic&nbsp;diagnostics&nbsp;=&nbsp;diagnostician.validate(myEObject,&nbsp;validationContext);<br>

</code>
</p>
</div>
<p></p>
<p>If the 
							<code class="code">Diagnostician</code> is unaware of the local validation registry, any validators registered locally will be ignored. An error message is generated in the console log if global registration is attempted.
						</p>
</div>
</div>
</div>
<div class="section" title="OCL Validators">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="OCLValidators"></a>OCL Validators</h3>
</div>
</div>
</div>
<p>The OCL project provides a variety of validators.</p>
<div class="section" title="OCLinEcoreEObjectValidator">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="OCLinEcoreEObjectValidator"></a>OCLinEcoreEObjectValidator</h4>
</div>
</div>
</div>
<p>Unfortunately EMF does not yet (2023-12 at time of writing) support message customization and so it must be activated by explicitly using an EValidator that is aware of the ValidationDelegateExtension extended API. This is available by using the OCLinEcoreEObjectValidator, which you may install globally by:</p>
<div class="literallayout">
<p>
<code class="code">EValidator.Registry.INSTANCE.put(null,&nbsp;new&nbsp;OCLinEcoreEObjectValidator());<br>

</code>
</p>
</div>
<p>
						but much better locally </p>
<div class="literallayout">
<p>
<code class="code">ValidationRegistryAdapter.getAdapter(myResourceSet).put(null,&nbsp;new&nbsp;OCLinEcoreEObjectValidator());<br>

</code>
</p>
</div>
<p></p>
<p>or more selectively by adjusting the inheritance of the Validator class generated by EMF from (for a model of a Company):</p>
<div class="literallayout">
<p>
<code class="code">import&nbsp;org.eclipse.emf.ecore.util.EObjectValidator;<br>
/*<br>
&nbsp;*&nbsp;&lt;!--&nbsp;begin-user-doc&nbsp;--<br>
&nbsp;*&nbsp;The&nbsp;&lt;b&gt;Validator&lt;/b&gt;&nbsp;for&nbsp;the&nbsp;model<br>
&nbsp;*&nbsp;&lt;!--&nbsp;end-user-doc&nbsp;--<br>
&nbsp;*&nbsp;@see&nbsp;company.CompanyPackag<br>
&nbsp;*<br>
public&nbsp;class&nbsp;CompanyValidator&nbsp;extends&nbsp;EObjectValidator&nbsp;<br>

</code>
</p>
</div>
<p>
						to</p>
<div class="literallayout">
<p>
<code class="code">import&nbsp;org.eclipse.ocl.xtext.oclinecore.validation.OCLinEcoreEObjectValidator;<br>
/*<br>
&nbsp;*&nbsp;&lt;!--&nbsp;begin-user-doc&nbsp;--<br>
&nbsp;*&nbsp;The&nbsp;&lt;b&gt;Validator&lt;/b&gt;&nbsp;for&nbsp;the&nbsp;model<br>
&nbsp;*&nbsp;&lt;!--&nbsp;end-user-doc&nbsp;--<br>
&nbsp;*&nbsp;@see&nbsp;company.CompanyPackag<br>
&nbsp;*&nbsp;@generated&nbsp;not<br>
&nbsp;*<br>
public&nbsp;class&nbsp;CompanyValidator&nbsp;extends&nbsp;OCLinEcoreEObjectValidator&nbsp;<br>

</code>
</p>
</div>
<p>
						Note the 
						<span class="bold"><strong>@generated not</strong></span> that indicates that the class interface is manually defined. Do not use 
						<span class="bold"><strong>@generated NOT</strong></span> since that indicates that the whole class is manually defined.
					</p>
</div>
<div class="section" title="CompleteOCLEObjectValidator">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="CompleteOCLEObjectValidator"></a>CompleteOCLEObjectValidator</h4>
</div>
</div>
</div>
<p>The CompleteOCLEObjectValidator is used to enable Complete OCL documents to participate in the validation processing of an Xtext editor.</p>
<p>The APIs for merging Complete OCL and Ecore as intermediate Pivots and then migrating the Pivot back to Ecore are experimental.</p>
</div>
</div>
</div>
</body>
</html>
